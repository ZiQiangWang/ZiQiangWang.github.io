---
title: 实现三方库按需引入与多主题方案
date: 2018-08-31 21:42:13
categories: 开源
tags:
 - js
 - package
---

> 300KB的三方库，在移动端，是庞然大物的大。

最近基于vue写了一堆移动端组件，本地demo运行无误，但是终究是要提供给别人使用。使用的方式就有待商榷，第一，可以直接在入口处引入并注册封装好的全部组件，项目所有位置可以直接使用。第二，提供按需引入的方式，用啥引入啥。

<!--more-->

# 引入方案

完整引入

```js
import Vue from 'vue';
import Sky from "sky";
Vue.use(Sky);
```

按需引入

```Js
import Vue from 'vue';
import { Button } from 'sky';
Vue.component(Button.name, Button);
```

在实现按需引入时，需要使用[babel-plugin-component](https://www.npmjs.com/package/babel-plugin-component)，

```
npm install babel-plugin-component -D
```

修改.babelrc

```json
{
  ...其他配置
  "plugins": [
    [
      "component",
      {
        "libraryName": "sky",
        "styleLibraryName": "theme-light"
      }
    ]
  ]
}
```

这种引入方式，对于生成的最终lib的目录结构有要求，因为插件**babel-plugin-component**本质上是做了下面的工作，将

```js
import { Button } from 'sky'
```

转为：

```js
var button = require('sky/lib/button')
require('sky/lib/button/style.css')
```

而通过指定**styleLibraryName **配置，可以设置样式文件的目录，变成如下形式：

```js
var button = require('sky/lib/button')
require('sky/lib/styleLibraryName/button.css')
```

因此，生成的lib结构如下所示：

```
- lib
  - theme-light // 'styleLibraryName'
    - base.css // required
    - index.css // required
    - button.css
    - input.css
    - ...
  - theme-dark
    - ...
  - index.js
  - button.js
  - input.js
  - ...
```

其中，**theme-light**和**theme-dark**是针对组件库的不同主题，生成的具有相同结构的目录。目录中base.css用于按需引入时，共有的样式文件，index.less是在整体引入时使用。

lib目录下的index.js用于整体引入，各个组件的js文件用于按需引入。这样，就可以完成两种方式引入了。

# 生成目录结构

与按需引入方案相匹配的目录结构，需要通过打包工具来生成。我的项目中，每个组件都是单文件组件，template、script、style混合在一起。通过webpack来生成对应的结构。

webpack支持多个entry打包，因此，通过脚本生成如下结构的文件，分别指定每个组件的名字，以及对应的路径。其中index是所有组件的汇总。

```js
module.exports = {
  "index": "./packages/index.js",
  "button": "./packages/button/index.js",
  "input": "./packages/input/index.js",
  ...
  "base.js": "./packages/base/index.js",
}
```

在webpack.config.js中，将entry设置成为上述对象，则可以统一打包多个组件，以及对应的样式文件。

因为使用的是webpack4，因此css的提取插件使用的是[mini-css-extract-plugin](https://www.npmjs.com/package/mini-css-extract-plugin)，通过指定filename，可以确定输出的样式文件的名字以及路径。

因为要生成一个base.css文件，因此额外定义了一个空组件base，只负责引入共有的样式，这样也可以自动生成base.css文件。

# 多主题生成

通常，组件的共有样式可以调整，通过覆盖一些基础样式变量，以及图片资源，达到切换主题的目的。

我采用的是less，预定义了theme相关变量在一个文件中，切换主题可以通过切换这个文件来实现。但是如何在一次构建中，同时生成多套主题，是一件比较麻烦的事。

我采用了如下方案：

## 定义主题颜色变量

定义了light和dark两个主题，使用相同的变量，规范两种主题下的不同颜色、阴影、渐变、计算规则等。分别命名为**light.less**和**dark.less**，不同主题对应的资源文件，位于指定位置的不同命名的文件夹下，使用相同的方式导入。

## 定义webpack配置文件

配置文件本身可以定义为一个函数，接受参数，返回配置的对象。因此，定义为如下形式：

```Js
module.exports = (theme) => {
  return {
    
    module: {
      rules: [
      	{
          test: /\.(png|jpe?g|svg)(\?.*)?$/,
          loader: 'url-loader',
          options: {
            limit: 10000,
            name: `theme-${theme}/images/[name].[ext]`
          }
        },
      ]
	},
 	plugins: [
      new MiniCssExtractPlugin({
        filename: `theme-${theme}/[name].css`,
      }),
    ],
    resolve: {
      alias: {
        'themes': resolve(`styles/themes/${theme}.less`),
      }
    }
  }
}
```

在这个配置中，所有与主题相关的资源，通过传入的theme变量，最终输出到指定的主题文件夹下。其中，还要记得定义themes的别名，为对应的主题文件名称。这样，在其他文件中使用该主题变量，可以使用下面方式引入，打包时，切换theme名字，则可以获得不同的主题样式文件。

```vue
<style lang="less">
  @import "~themes";
</stlye>
```

## 多次打包

在打包时，想在一次打包过程中同时生成两份主题文件目录比较麻烦，因此通过打包两次的方式。因为js文件在这个过程中不会改变，通过修改theme，可以生成多个主题文件夹。

```js
const webpack = require('webpack');
const webpackConfig = require('./webpack.prod.conf');
const themes = ['light', 'dark'];
themes.forEach(theme => {
    webpack(webpackConfig(theme), (err, stats) => {
        
    });
})
```

## 主题切换

在使用时，想要切换主题，只需要修改.babelrc中的配置即可，例如：将**styleLibraryName**改为theme-dark

```Json
{
  ...其他配置
  "plugins": [
    [
      "component",
      {
        "libraryName": "sky",
        "styleLibraryName": "theme-dark"
      }
    ]
  ]
}
```

